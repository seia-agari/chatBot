// ===== マニュアルQ&A（講師向け・正式文面） =====

// --- Q&Aデータ ---
const QA = [
  // 【理念・目標編】
  {
    q: "理念（スマイルスタディの理念は？）",
    kws: ["理念","想い","ビジョン","方針","スマイルスタディ"],
    a: `【回答】
スマイルスタディの理念は「子どもたちの夢や目標を叶える応援がしたい」という想いを、講師全員で共有することです。入塾前の成績に関わらず、一人ひとりの可能性を最後まで信じ、成長に寄り添います。`
  },
  {
    q: "教室全体の目標は？",
    kws: ["目標","全員成績アップ","全員合格","職場","働き甲斐"],
    a: `【回答】
教室全体の目標は次の3点です。
・全員成績アップ
・全員合格
・楽しく、働き甲斐のある職場づくり`
  },
  {
    q: "講師の主な仕事は？",
    kws: ["講師の仕事","役割","業務","成績アップ","合格","日程","変更","ミスゼロ","2日以内"],
    a: `【回答】
講師の主な仕事は以下の2点です。
1) 成績アップ・志望校合格：目標と現状のギャップを把握し、計画的に埋めていきます。
2) 授業日程案内・変更対応：保護者様との連絡を丁寧に行い、「ミスゼロ」を徹底。原則「2日以内対応」を守ります。`
  },

  // 【指導方針・4つのSC】
  {
    q: "4つのSCとは？",
    kws: ["4つのSC","SC","指導方針","カリキュラム","習慣化","コーチング","コミュニティ"],
    a: `【回答】
次の4つを総称して「SC」と呼びます。
・Smile Curriculum：学びの設計とPDCAの運用
・Self Control：学習の習慣化と自己管理
・Smart Coaching：寄り添い、行動を引き出す関わり
・Study Community：学び合う空間の創出`
  },
  {
    q: "SC実践のポイント",
    kws: ["SCのポイント","実践","目的","成果","宿題","意義","生活面","共有","モチベーション","SC"],
    a: `【回答】
SCを効果的に実践するための要点は次の通りです。
・毎回の授業で「目的」と「成果」を明確化する
・宿題の意味を説明し、単なる作業から「やる意義」へ転換する
・勉強だけでなく生活面にも関心を払い、継続を支える
・生徒同士で努力や工夫を共有し、モチベーションを高める`
  },

  // 【授業・報告書編】
  {
    q: "指導報告書の公開期限",
    kws: ["報告書","指導報告書","公開","締切","期限","21:50"],
    a: `【回答】
指導報告書は「当日21:50まで」に公開してください。時間厳守でお願いします。`
  },
  {
    q: "報告書コメントの書き方",
    kws: ["報告書","コメント","書き方","文字数","170文字","丁寧","誤字","脱字"],
    a: `【回答】
Comiruで担当生徒を選択し、「＋指導報告書作成」から授業区分・出席状況・授業時間・宿題状況・指導科目を入力します。
授業内容には単元名やテーマ（例：一次関数、長文読解など）を記載し、理解度を星で選択してください。
コメント欄には170文字以上で、具体的な指導内容・生徒の様子・今後の課題や方針などを丁寧に記載してください。
誤字脱字がないか確認後、「公開」に設定します。

※公開前に変換ミスや脱字の最終確認を行ってください。`
  },
  {
    q: "連続授業時の報告書",
    kws: ["連続授業","2コマ連続","複数コマ","報告","1コマずつ"],
    a: `【回答】
連続授業であっても、指導報告書は必ず「1コマごと」に作成・公開してください。`
  },

  // 【欠席・振替対応編】
  {
    q: "振替の連絡期限",
    kws: ["振替","欠席","連絡タイミング","前日21時","当日90分前","無断欠席"],
    a: `【回答】
振替の可否は次の通りです。
・前日21:00まで：振替可
・当日開始90分前まで：振替可
・それ以降や無断欠席：振替不可
※例外対応が必要な場合は、必ず運営に相談してください。`
  },
  {
    q: "欠席時の報告書",
    kws: ["欠席","報告書","記録","振替対象外","当日欠席"],
    a: `【回答】
欠席の場合は、報告書を「欠席」として登録し、返信欄に「振替対象外である旨」を明記してください。`
  },
  // 【振替対象（授業開始90分前までの連絡）】
{
  q: "前日21時までに欠席連絡をした場合、振替はしますか？",
  kws: ["振替", "前日", "連絡", "欠席", "欠席連絡", "休み", "休講", "欠席申請"],
  a: `【回答】
はい、振替をお願いいたします。振替日時を相談し、決定後カレンダーの振替ボタンで変更してください。`
},
{
  q: "授業当日、開始90分前までに欠席連絡をした場合、振替はしますか？",
  kws: ["振替", "当日", "連絡", "欠席", "欠席連絡", "休み", "休講", "直前", "当日申請"],
  a: `【回答】
はい、振替をお願いいたします。振替日時を相談し、決定後カレンダーの振替ボタンで変更してください。`
},
{
  q: "学校行事（体育祭、音楽会、修学旅行、部活動の大会など）で欠席する場合、振替はしますか？",
  kws: ["振替", "学校行事", "体育祭", "音楽会", "修学旅行", "部活動", "大会", "行事", "学校イベント", "合唱コンクール"],
  a: `【回答】
授業開始90分前までのご連絡であれば振替をお願いいたします。`
},
{
  q: "家庭の都合（旅行、送迎、法事など）で欠席する場合、振替はしますか？",
  kws: ["振替", "家庭都合", "旅行", "送迎", "法事", "私用", "家庭事情", "プライベート"],
  a: `【回答】
授業開始90分前までのご連絡であれば振替をお願いいたします。`
},
{
  q: "講師都合で授業が実施できない場合はどうなりますか？",
  kws: ["振替", "講師都合", "代講", "講師欠席", "講師不在", "講師変更", "先生欠席"],
  a: `【回答】
振替をお願いいたします。または、代講を手配する形をとってください。`
},
{
  q: "悪天候の場合はどうなりますか？",
  kws: ["振替", "悪天候", "台風", "大雪", "天候不良", "雪", "豪雨", "悪天候時"],
  a: `【回答】
悪天候は事前に予測できる場合が多いため、授業開始90分前までにこちらからアナウンスし、必要であれば振替をご提案いたします。`
},

// 【振替不可（原則：授業開始90分前以降の連絡）】
{
  q: "授業開始90分前以降の連絡や無断欠席の場合、振替はしますか？",
  kws: ["振替", "直前", "連絡", "無断欠席", "欠席", "当日", "遅刻連絡", "直前欠席"],
  a: `【回答】
振替は原則として不可です。この場合、授業は「欠席」として処理し、指導報告書の返信欄に「振替対象外である旨」を記載してください。`
},
{
  q: "不可抗力（急な体調不良、電車遅延、交通トラブルなど）の場合、振替はしますか？",
  kws: ["振替", "不可抗力", "体調不良", "電車遅延", "交通トラブル", "遅延", "急病", "事故"],
  a: `【回答】
原則として振替はいたしません。遅刻してでも来ていただくようご対応お願いいたします。来塾されない場合はコマが消化されてしまいます。`
},
{
  q: "直前に悪天候で来られない場合は振替しますか？",
  kws: ["振替", "悪天候", "直前", "天候不良", "台風", "大雪", "荒天", "直前欠席"],
  a: `【回答】
授業開始90分前以降の直前連絡は振替不可です。悪天候が予想される場合は、90分前までにご連絡いただければ振替をご提案いたします。`
},

  // 【カレンダー・お知らせ編】
  {
    q: "カレンダー登録の手順",
    kws: ["カレンダー","日程登録","google","授業","登録"],
    a: `【回答】
授業登録
1. Google Calendarの授業登録フォームを開く
2. 講師・生徒名・教科・授業種別・日付など必要項目を入力
3. 画面下の青色「➡」ボタンをクリックして登録

授業登録内容の確認
1. 授業登録フォーム下の「生徒カレンダーフォーム」から該当生徒を選択
2. 青色「➡」ボタンでカレンダーを表示し、正しく反映されているか確認

※ 登録・確認時は、日時・科目・担当講師の誤りがないか必ずダブルチェックしてください。`
  },
  {
    q: "カレンダーURLの使い道",
    kws: ["カレンダーURL","お知らせ","Comiru","共有","リンク","url"],
    a: `【回答】
カレンダーURLは、Comiruのお知らせ本文に貼り付けて保護者へ共有します。`
  },
    {
    q: "Comiruでお知らせ作成から保存・報告までの流れ",
    kws: ["カレンダーURL","お知らせ","Comiru","下書き保存","リンク","url"],
    a: `【回答】
1. Comiruにログインし、「お知らせ」→「新規作成」
2. 宛先を「保護者」と「生徒」に設定し、生徒名をチェックして「確認」
3. お知らせの日付を入力
4. テンプレート「〇月の授業日程につきまして」を選択
5. タイトル・本文を編集し、本文中のリンク欄に生徒カレンダーURLを貼り付け
6. 内容確認後「保存」をクリック（下書き保存状態になる）
7. 公開したい場合は上利へ報告（講師は直接公開できません）`
  },
  

  // 【面談編】
  {
    q: "面談の目的",
    kws: ["面談","目的","共有","学習状況","成績","方針","保護者"],
    a: `【回答】
面談の目的は、生徒の学習状況・成績・今後の方針を保護者と共有し、最適な学習環境を提案することです。期待値のすり合わせを丁寧に行います。`
  },
  {
    q: "面談準備でやること",
    kws: ["面談準備","資料","通知表","模試","A4","1〜2枚","面談"],
    a: `【回答】
面談前に必ず以下を行ってください。
・成績資料（通知表・模試結果等）の事前回収
・当日の説明用「面談資料（A4/1〜2枚）」の作成（現状・課題・提案を簡潔に整理）`
  },
  {
    q: "面談の業務フロー",
    kws: ["面談準備","資料","内容","手順","準備","面談"],
    a: `【回答】
面談は以下の5ステップで行います。

1. 面談日時のアポ取り・成績資料の入手
    - 授業報告書で日程提案 → 確定後カレンダー登録・塾長へLINE報告
    - 成績資料（通知表・模試結果など）を必ず事前に入手
2. 面談資料作成
    - A4 1〜2枚、Word作成
    - 保護者用1部印刷（印刷は上利が対応）、データをLINE送信
    - 記載内容：成績分析・課題と改善案・今後の方針・注意点
3. 面談実施（30〜40分）
    - 早めの準備、明るく丁寧な挨拶
    - 約束事はメモ、成績資料をしっかり把握
4. Comiru「お知らせ」作成（当日中）
    - 面談まとめを作成し下書き保存、塾長にLINE報告
    - ネクストアクションを具体的に明記
5. Comiru「面談記録」作成（関係者共有用）
    - 面談日時と内容を入力し保存
    - 他講師への依頼があればLINEで連絡`
  },
  // 【引継ぎ編】
  {
    q: "引継ぎ資料の5項目",
    kws: ["引継ぎ","資料","5項目","基本情報","理解度","使用教材","進捗","ルーティン","注意点"],
    a: `【回答】
引継ぎ資料には、最低限以下の5項目を明記してください。
1) 生徒の基本情報・性格・通塾状況
2) 教科ごとの理解度・課題・目標
3) 使用教材と進捗
4) 授業の進め方・ルーティン
5) 注意点や特記事項（配慮事項を含む）`
  },
  {
    q: "引継ぎ資料の期限",
    kws: ["引継ぎ","資料","期限"],
    a: `【回答】
引継ぎ資料はWordファイル（A4サイズ1〜2枚程度）で作成し、上利へLINEで送付してください。

提出期限は担当が変わる月の末日16:00までです。報酬は生徒管理業務に含まれ、期限厳守です。提出が遅れると新担当の授業に支障をきたすため必ず守ってください。`
  },

  // 【給与報告編】
  {
    q: "給与報告",
    kws: ["給与","給与報告","いつ","方法"],
    a: `【回答】
毎月30日に、Notionトップページの「給与報告フォーム」から報告してください。`
  },

  // 【体験授業編】
  {
    q: "体験授業の到着時間",
    kws: ["体験授業","到着","10分前","集合","遅刻"],
    a: `【回答】
体験授業当日は、授業開始「10分前」までに必ず到着してください。準備とヒアリングの時間を確保します。`
  },
  {
    q: "体験授業で意識すること",
    kws: ["体験授業","意識","Before After","成功体験","この先生に教わったから"],
    a: `【回答】
授業内では「Before→After」を体験させ、「この先生に教わったから解けた！」という成功体験を必ず作ってください。具体的な解き方の型や再現手順を持ち帰らせます。`
  },
  {
    q: "体験授業の流れ",
    kws: ["体験授業","流れ","構成"],
    a: `【回答】
体験授業はサンドイッチ形式で行います。

1. 最初の面談（保護者・生徒）
    - 学習状況（成績・苦手科目・勉強習慣）をヒアリング
    - 塾に何を求めているかを確認（成績アップ・自習習慣・受験対策など）
    - 生徒が話しやすい雰囲気を作る
2. 授業
    - 生徒タイプに合わせた関わり（やる気が薄い場合は雑談で緊張をほぐす）
    - Before→Afterの成功体験を与える（簡単な問題でOK）
3. 最後の面談
    - この塾でどう成長できるか未来像を提案
    - 例：「英語文法を整理しながら長文読解に自信を」「数学は基礎から復習して関数につなげる」`
  },

// 【カレンダー更新・日程変更】
{
  q: "カレンダー更新や日程変更の時にやってはいけないことは？",
  kws: [
    "カレンダー", "更新", "NG", "禁止", "やってはいけない", "注意点", 
    "日程", "変更", "NG例", "禁止行為", "スケジュール", "予定変更", 
    "日程変更禁止", "更新禁止", "予定調整", "不適切"
  ],
  a: `【回答】
カレンダー更新・日程変更時のNG例は以下の通りです。

- 理由が曖昧・不適切：「私情により」「都合が悪くなったため」「他の生徒を優先したため」などは不可
- 保護者確認前に更新：本人了承だけで変更するのはNG
- 連絡が遅い：当日・直前連絡、変更後の事後報告は避ける
- 記録が残らない連絡：Comiruを使わず口頭やLINEだけで変更するのは不可
- 配慮不足な言葉：「この時間はもう無理」「代講に変わります」など、一方的・冷たい印象の言い方

【ポイント】
1. 必ず保護者確認後に更新する
2. 理由は具体的かつ配慮のある表現にする
3. できるだけ早く連絡する`
},
{
  q: "日程変更の正しい流れは？",
  kws: [
    "日程", "変更", "正しい", "流れ", "手順", "方法", "予定変更", "予定調整", 
    "カレンダー", "更新", "スケジュール", "変更手順", "日程調整", "やり方", "変更方法"
  ],
  a: `【回答】
日程変更の正しい流れは以下の通りです。

1. 生徒本人に事情を説明（必ずではないですが、生徒本人にも事情を説明できたら望ましいです）
2. Comiruで保護者に連絡（理由を明記）
3. 保護者了承を確認
4. カレンダーを更新（了承後に実施）

※ 直前変更は避け、混乱しそうな場合は必ず上利または塾長に相談してください。`
},

   // 【北辰テストお申込み編】
  {
    q: "北辰テストの申し込み手続き",
    kws: ["北辰","北辰テスト","お申込み","領収書","費用"],
    a: `【回答】
北辰テストの申し込み手順は以下の通りです。

1. 費用の受け取り：4,950円をお預かりします。
2. 領収書の発行：受付にある写真付き用紙からA.領収書を切り離し、生徒に渡します。日付・生徒名を記入し、領収印に塾長のシャチハタ印を押してください。
3. 現金の処理：現金はコピー機横の「あいか」のトレーに入れます。
4. 塾長への報告：LINEで『北辰テスト〇〇君申込あり』と報告してください。

※領収書付き用紙は塾受付に置いてあります。`
  },

   // 【オープン、クローズ業務】
  {
    q: "教室オープン時の業務手順は？",
    kws: ["教室オープン","開け方","オープン","鍵","どこ"],
    a: `【回答】
教室オープン時は以下の手順で行います。

1. 塾長に入室報告LINEを送る
2. 外の自転車置き場のチェーンを入口に近い方から順に2つ外す
3. 看板を入口外に出す
4. 傘立ての下の置き鍵で入室し、鍵は一旦傘立ての下に戻す
5. 授業スペースと自習室の窓を開け、一度換気する`
  },
  {
    q: "教室クローズ時の業務手順は？",
    kws: ["教室クローズ","閉め方","クローズ","鍵","どこ"],
    a: `【回答】
教室クローズ時は以下の手順で行います。

1. 窓が開いていないか確認
2. エアコン電源OFF（授業スペース・自習室）
3. 換気扇OFF（トイレ・自習室）
4. 消灯
5. 鍵を閉めて傘立ての下に戻す
6. 階段の電気を全て消灯
7. 看板を外から中へ入れる（階段を下りた一番隅・3階の大家さんが通る際に邪魔にならない場所に置く）
8. 自転車置き場のチェーンを2つかける
9. 塾長に完了報告LINEを送る`
  },


  // 【困ったとき】
  // 【講師業務・給与関連】
{
  q: "生徒管理費はいくらですか？",
  kws: ["生徒管理費", "管理費", "費用", "料金", "金額", "授業料", "月額"],
  a: `【回答】
担当生徒の人数に関係なく 2,000円 です。`
},
{
  q: "昇給はありますか？",
  kws: ["昇給", "時給アップ", "給料アップ", "給与改定", "賃金", "給与", "報酬"],
  a: `【回答】
先生方の今後のご尽力や成果に応じて、昇給させていただく場合がございます。`
},
{
  q: "交通費は支給されますか？",
  kws: ["交通費", "支給額", "交通費支給", "交通費補助", "電車代", "バス代", "交通手当"],
  a: `【回答】
最大交通費支給額は、1日往復400円までです。`
},
{
  q: "コマとコマの間の給与は支給されますか？",
  kws: ["コマ間", "給与", "休憩時間", "時給", "授業間", "事務給", "報酬"],
  a: `【回答】
コマ給のみ発生します。事務給は塾長から依頼された時のみ発生するため、その都度ご確認ください。`
},

// 【勤務対応・休暇関連】
{
  q: "代講をお願いする場合はどうすればいいですか？",
  kws: ["代講", "手順", "代講依頼", "授業代行", "代理講師", "講師変更", "講師交代"],
  a: `【回答】
まずは上利先生にご連絡ください。必要に応じて代講の手配を行います。`
},
{
  q: "留学などで長期休みをしたい場合はどうすればいいですか？",
  kws: ["長期休み", "休暇", "長期欠勤", "申請", "休職", "休業", "長期不在"],
  a: `【回答】
まずは上利先生にご相談ください。期間や対応方法について確認いたします。`
},
{
  q: "授業当日に体調不良になってしまいました。どうすればいいですか？",
  kws: ["体調不良", "当日対応", "欠勤連絡", "病欠", "発熱", "風邪", "当日欠席"],
  a: `【回答】
本日の授業を振替たい旨を生徒にお知らせする必要がありますので、必ず午前中までに上利先生と塾長にご連絡ください。`
},

// 【授業中の対応】
{
  q: "宿題を忘れた生徒への対応方法は？",
  kws: ["宿題", "忘れた", "対応", "未提出", "宿題忘れ", "宿題未完了", "課題忘れ"],
  a: `【回答】
まず理由を聞き、忘れた場合はその場で短時間でできる範囲を行わせましょう。繰り返し忘れる場合は、上利先生へ報告してください。`
},
{
  q: "授業で時間が余ったときはどうすればいいですか？",
  kws: ["授業", "時間余り", "対応", "空き時間", "余った時間", "授業残り時間", "時間調整"],
  a: `【回答】
復習や宿題の予習、苦手単元の補強を行ってください。生徒の理解度に合わせて柔軟に活用しましょう。`
},
{
  q: "生徒が泣いてしまった場合の対応は？",
  kws: ["生徒", "泣いた", "対応", "涙", "感情的", "トラブル", "メンタルケア"],
  a: `【回答】
落ち着かせる時間を取り、理由を優しく聞いてください。授業に戻れない場合は保護者へ連絡し、上利先生にも報告してください。`
},
{
  q: "生徒同士で喧嘩になった場合はどうしますか？",
  kws: ["生徒", "喧嘩", "対応", "けんか", "トラブル", "揉め事", "衝突"],
  a: `【回答】
即座に止めて安全を確保し、状況を把握します。必要に応じて席を離し、その後保護者と上利先生へ報告してください。`
},
{
  q: "授業中に生徒がスマホを触っていたらどうしますか？",
  kws: ["授業中", "スマホ", "対応", "携帯", "スマートフォン", "携帯電話", "使用禁止"],
  a: `【回答】
静かに注意し、机の上から下げてもらってください。繰り返す場合は上利先生へ報告してください。`
},
{
  q: "生徒が遅刻したときの対応は？",
  kws: ["生徒", "遅刻", "対応", "遅延", "遅れて到着", "遅れ", "開始遅れ"],
  a: `【回答】
理由を確認し、授業可能な範囲で対応してください。頻発する場合は上利先生へ共有してください。`
},

// 【授業準備・運営】
{
  q: "新しい生徒を初めて担当するときに確認すべきことは？",
  kws: ["新規生徒", "初回", "確認事項", "初回授業", "情報確認", "事前準備", "面談内容"],
  a: `【回答】
学習状況、得意不得意、目標、使用教材、宿題の有無を必ず確認してください。必要なら上利先生から事前情報を受け取ってください。`
},
{
  q: "宿題量の調整はどのように行えばいいですか？",
  kws: ["宿題量", "調整", "方法", "課題量", "宿題設定", "宿題管理", "課題調整","宿題"],
  a: `【回答】
生徒の学習スピードや理解度、他教科の負担を考慮して調整します。大幅に変える場合は上利先生に相談してください。`
},
{
  q: "授業内容を急遽変更してもいいですか？",
  kws: ["授業内容", "急遽変更", "変更", "授業変更", "臨時変更", "予定変更", "授業調整"],
  a: `【回答】
生徒の理解度や学校の進度に応じた変更は可能ですが、事前に可能な範囲で上利先生へ報告してください。`
},
{
  q: "定期テスト直前の授業で優先すべきことは？",
  kws: ["定期テスト直前", "授業", "優先事項", "試験前", "テスト前対策", "試験準備", "直前対策","定期テスト"],
  a: `【回答】
テスト範囲の総復習と、苦手分野の重点対策を優先してください。過去の間違い問題のやり直しも効果的です。`
},
  {
    q: "不安や疑問がある時の相談先",
    kws: ["困った","不安","疑問","相談","上利","塾長","ヘルプ"],
    a: `【回答】
不安や疑問がある場合は、一人で抱え込まず、必ず上利または塾長へ相談してください。早期共有が最善策につながります。`
  },
];

// --- 検索ロジック（簡易） ---
function normalize(s){
  return (s || "")
    .toLowerCase()
    .replace(/\s+/g, "")
    .replace(/[！!？?。．、,\.：:・\-—–]/g, "");
}

function score(entry, text){
  const t = normalize(text);
  let s = 0;
  for(const k of entry.kws){
    if(t.includes(normalize(k))) s += 2; // キーワード一致を強めに
  }
  if(t.includes(normalize(entry.q))) s += 1; // 見出し一致
  return s;
}

// 「Q12」「q12」のように番号から直接検索できる補助
function findByNumber(text){
  const m = String(text).trim().match(/^q?\s*(\d{1,2})$/i);
  if(!m) return null;
  const idx = Number(m[1]) - 1;
  return (idx >= 0 && idx < QA.length) ? QA[idx] : null;
}

function answer(text) {
  // 1) Q番号直指定
  const direct = findByNumber(text);
  if (direct) return formatAnswer(direct);

  // 2) スコア上位3件
  const scored = QA.map(item => ({ item, sc: score(item, text) }))
                   .filter(o => o.sc > 0)
                   .sort((a, b) => b.sc - a.sc)
                   .slice(0, 3);
  if (scored.length > 0) {
    return scored
      .map(o => formatAnswer(o.item))
      .join("\n\n---\n\n"); // 区切り線で結合
  }

  // 3) ヒットなし
  return [
    "該当する回答が見つかりませんでした。次のキーワードでお試しください。",
    "例）「振替」「報告書 コメント」「面談 目的」「引継ぎ 5項目」",
  ].join("\n");
}

function formatAnswer(entry){
  return `【項目】${entry.q}\n${entry.a}`;
}

// --- UI ---
const form = document.getElementById('f');
const input = document.getElementById('q');
const log = document.getElementById('log');

function push(type, text){
  const div = document.createElement('div');
  div.className = `msg ${type}`;
  div.textContent = text;
  log.prepend(div);
}

form?.addEventListener('submit', (e)=>{
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  push('user', text);
  push('bot', answer(text));
  input.value = '';
});
